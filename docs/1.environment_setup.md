# 开发环境搭建文档

## 1. 简介
本文档记录了 TinyIM 项目基于 Docker 容器化环境的搭建过程。该环境集成了 C++20 开发所需的编译器、依赖库以及 MySQL (一主两从高可用集群)、Redis、Etcd 等基础设施。

## 2. Docker 环境配置

### 2.1 目录结构
所有基础设施相关的配置位于 `infra/` 目录下：
```text
infra/
├── docker/
│   ├── config/            # 配置文件 (MySQL/Redis等)
│   ├── setup.sh           # 容器内自启动的集群配置脚本
│   ├── Dockerfile         # 开发环境镜像定义
│   └── docker-compose.yml # 容器编排配置
└── scripts/
    ├── enter_dev.bat      # 快速进入开发容器脚本
    └── setup_mysql_replication.sh # (备用)用于手动配置主从复制的脚本
```

### 2.2 镜像说明 (`Dockerfile`)
开发镜像基于 **Ubuntu 22.04 LTS** 构建，集成了以下核心组件：
*   **基础工具**: `gcc/g++` (C++20支持), `cmake`, `make`, `gdb`, `git`
*   **依赖库**:
    *   `Boost`: Asio, Beast 等核心库
    *   `gRPC` / `Protobuf`: 微服务通信
    *   `MySQL Client`: 数据库连接
    *   `Hiredis`: Redis 连接 (C Interface)
    *   `spdlog`: 高性能日志库
    *   `nlohmann-json`: JSON 解析库
    *   `Google Test (GTest)`: 单元测试框架 (已手动编译安装)
*   **优化**:
    *   配置了阿里云 Apt 镜像源以加速构建。
    *   解决了 bitnami/etcd 镜像拉取受限问题，改用 `quay.io/coreos/etcd`。

### 2.3 服务编排 (`docker-compose.yml`)
启动了以下服务容器，构建了一个完整的微服务基础设施：

| 服务名 | 容器名 | 端口映射 (宿主机:容器) | 说明 |
| :--- | :--- | :--- | :--- |
| **dev** | `tinyim_dev` | - | **核心开发容器**，挂载本地源码目录 `/app` |
| **mysql-master** | `tinyim_mysql_master` | 3306:3306 | **MySQL 主库** (写)，Root密码: `root` |
| **mysql-slave-1** | `tinyim_mysql_slave_1` | 3307:3306 | **MySQL 从库 1** (读)，只读模式 |
| **mysql-slave-2** | `tinyim_mysql_slave_2` | 3308:3306 | **MySQL 从库 2** (读)，只读模式 |
| **redis** | `tinyim_redis` | 6379:6379 | 缓存与 Session 存储 |
| **etcd** | `tinyim_etcd` | 2379:2379 | 服务注册与发现 |
| **ops-setup** | `tinyim_setup` | - | **自动化配置任务**，启动即运行，自动建立主从复制关系 |

## 3. 快速开始

### 3.1 启动环境
在 `infra/docker` 目录下，执行以下命令一键构建并启动所有服务：
```bash
# 构建并后台启动
docker-compose up -d --build
```
> **注意**: 启动后，`ops-setup` 容器会自动运行脚本配置 MySQL 主从同步。你可以通过 `docker logs tinyim_setup` 查看配置日志。

### 3.2 验证数据库集群状态
环境启动后，可以通过以下方式验证主从复制是否正常工作：
1. **查看自动配置日志**:
   ```bash
   docker logs tinyim_setup
   ```
   如果看到 `Slave_IO_Running: Yes` 和 `Slave_SQL_Running: Yes`，说明集群配置成功。

2. **手动检查**:
   连接到任意 Slave 端口 (3307 或 3308) 执行 SQL:
   ```sql
   SHOW SLAVE STATUS\G;
   ```

### 3.3 进入开发容器
使用提供的脚本快速进入容器内的 Shell 环境进行开发：
```bash
# Windows
.\infra\scripts\enter_dev.bat

# 或者手动执行
docker exec -it tinyim_dev bash
```

### 3.4 验证开发环境
进入容器后，可执行以下命令验证依赖库：
```bash
cmake --version          # 验证构建工具
ls /usr/lib/libgtest.a   # 验证 GTest 库
ls /usr/include/mysql    # 验证 MySQL 开发库
```

## 4. 常见问题记录
*   **Etcd 镜像拉取失败**: 由于国内网络对 Docker Hub 部分镜像限制，已将镜像源切换为 `quay.io/coreos/etcd:v3.5.9`。
*   **GTest 找不到**: Ubuntu 的 `libgtest-dev` 包不含预编译库，我们在 Dockerfile 中手动添加了编译和安装步骤。
*   **MySQL 主从未同步**: 检查 `tinyim_setup` 容器的日志。如果是全新启动，脚本会自动处理。如果挂载卷中有旧数据，可能需要先执行 `docker-compose down -v` 清除数据卷重新启动。
